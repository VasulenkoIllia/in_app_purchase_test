import bodyParser from "body-parser";
import AppleBusiness, { ProductType } from "./AppleBusiness";
import https from "https";
import {IncomingMessage} from "http";
import url from "url";
const request = require('request');
const cors = require('cors')
const express = require('express')
const app = express()
const port = 3000
app.use(cors())
app.use(bodyParser.json({limit: '2mb'}))
app.use(bodyParser.urlencoded({
    extended: true,
    limit: '2mb'
}));
const handler = {
    sendHttp(option: any, body: any = null, cookie: any = null) {
        return new Promise((resolve, reject) => {

            let defaultOptions: any = {
                method: 'GET',
                host: '127.0.0.1',
                port: 443
            }

            if (body && (!option.headers || !option.headers['Content-Type'])) {
                if (!defaultOptions.headers) defaultOptions.headers = {};
                defaultOptions.headers['Content-Type'] = 'application/json';
            }

            if (cookie) {
                if (!defaultOptions.headers) defaultOptions.headers = {};
                defaultOptions.headers['cookie'] = cookie;
            }

            Object.assign(defaultOptions, option);


            let request = https.request(defaultOptions, (response: IncomingMessage) => {
                response.setEncoding('utf8');
                let data = '';

                response.on('data', (chunk) => {
                    data += chunk;
                })

                response.on('close', (endData: any) => {
                    if (/^3[0-9]+/.test(response.statusCode!.toString())) {
                        let parsedUrl = url.parse(response.headers.location!);
                        option.host = parsedUrl.host;
                        option.path = parsedUrl.path;
                        let cookie = response.headers['set-cookie'];

                        this.sendHttp(option, body, cookie)
                            .then((data: any) => {
                                resolve(data);
                            }, (err: any) => {
                                reject(err);
                            })
                        return
                    }
                    if (response.statusCode !== 200) return reject(data);
                    resolve(data);
                })
            })

            request.on('error', (err) => {
                reject(err);
            })

            if (body && typeof body === 'object') request.write(JSON.stringify(body));
            request.end();
        })
    }

}


const secret = 'bf10cc82456e4e30bcc5205706e2644f';

const CONSTANTS = {
    apple: {
        password: secret,
        host: 'buy.itunes.apple.com',
        sandbox: 'sandbox.itunes.apple.com',
        path: '/verifyReceipt',
        apiHost: 'api.appstoreconnect.apple.com',
        pathToCheckSales: '/v1/salesReports',
    }
}
// app.all('*', async (req, res) => {
//
//     // console.log(req);
//     //
//     // console.log(req.query, req.body);
//     // console.log(res)
//     const productId = 'soNFT_expendable';
//     const token = "";
//     const token2 = "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";
//     const result = await new AppleBusiness(CONSTANTS, handler).verifyAndParseReceipt(productId, token, ProductType.Consumable)
//
//     // console.log(result)
//
//     res.json({
//         data: 1
//     })
//     console.log( req.body );
// })

app.options('*', async (req, res) => {

    console.log('Options request');
    //
    // console.log(req.query, req.body);
    // console.log(res)
    // const productId = 'soNFT_expendable';
    // const token = "";
    // const token2 = "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";
    // const result = await new AppleBusiness(CONSTANTS, handler).verifyAndParseReceipt(productId, token, ProductType.Consumable)

    // console.log(result)

    // res.json({
    //     data: 1
    // })
    // console.log( req.body );
    res.status(200).send()
})

app.post('*', async (req, res) => {
    console.log("============")
        let data = {}

        data['password'] = 'bf10cc82456e4e30bcc5205706e2644f'
        data['receipt-data'] = req.body.transaction.appStoreReceipt
        data['exclude-old-transactions'] = false

        const clientServerOptions = {
            uri: 'https://sandbox.itunes.apple.com/verifyReceipt',
            body: JSON.stringify(data),
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }

    console.log(req.body)
       const a = await request(clientServerOptions, function (error, response) {
            if(JSON.parse(response.body).transaction?.transaction_id) {
                res.status(200).send({
                    ok: true,
                    data: {
                        transaction: {}
                    }
                });
                console.log('NEW PURCHASE')
            }
            else if(!JSON.parse(response.body).transaction?.transaction_id) {
                res.status(200).send({
                    ok : true,
                    data : {
                        transaction : {  }
                    }
                })
                console.log('LOAD OLD PURCHASES')
            }
            else {
                res.status(200).send({
                    ok : false,
                    data : {
                        code: 6778003
                    },
                    error: {
                        message: "ERROR"
                    }
                })
            }
            return;
        });


})

// app.get('*', (req,res) => {
//     res.send('Response')
// })
app.listen(port, '192.168.1.8',() => {
    console.log(`Example app listening on port ${port}`)
})